= Crate Digger
James Elliott <james@deepsymmetry.org>
:icons: font
:experimental:

// Set up support for relative links on GitHub, and give it
// usable icons for admonitions, w00t! Add more conditions
// if you need to support other environments and extensions.
ifdef::env-github[]
:outfilesuffix: .adoc
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::env-github[]

A Java library for fetching and parsing rekordbox media exports and
track analysis files.

image:https://img.shields.io/badge/License-Eclipse%20Public%20License%201.0-blue.svg[link="#license"]

This project uses the http://kaitai.io[Kaitai Struct] compiler with
the help of a https://github.com/valery1707/kaitai-maven-plugin[Maven
plugin] to create classes that can parse and output binary data
strutures in a convenient and efficient way. It uses them to create
Java classes, because it was created to support
https://github.com/Deep-Symmetry/beat-link[Beat Link], but other
projects can use them to output code for other languages.

== PDB Database

The file link:src/main/resources/kaitai/pdb.ksy[`pdb.ksy`] contains
the structure definitions needed to parse exported rekordbox databases
(`export.pdb` files).

NOTE: Huge thanks to https://github.com/flesniak[Fabian Lesniak] for
figuring out the details of how to interpret these files in his
https://github.com/flesniak/python-prodj-link[python-prodj-link]
project and https://github.com/GreyCat[Mikhail Yakshin] for helping me
quickly learn the more subtle aspects of Kaitai Struct. And this was
all started by a question
https://reverseengineering.stackexchange.com/users/4599/evan-purkhiser[Evan
Purkhiser] posted on
https://reverseengineering.stackexchange.com/questions/4311/help-reversing-a-edb-database-file-for-pioneers-rekordbox-software[Stack
Exchange].


=== Exploring the Analysis

One of the amazingly cool things about Kaitai Struct is that you can
use its https://ide.kaitai.io/#[Web IDE] to see how the structure
definitions work and visually explore the contents of files you are
analyzing. This also means you can look inside your own `.pdb` files
and check my work, or get a better understanding of how to use the
generated parsers. To do that, simply upload the `.pdb` file you want
to examine to the Web IDE (it doesn't actually go to the web, it just
gets put in your local browser storage), then also upload my
link:src/main/resources/kaitai/pdb.ksy[`pdb.ksy`] file, and the Web
IDE will parse the exported database, letting you explore the
structures in the tree view, and see the corresponding raw bytes in
the hex viewer.

TIP: You can find the `export.pdb` file on a media stick prepared by
rekordbox inside the `PIONEER` folder, which may be invisible in the
Finder, but you can open it using Terminal commands if you have to. To
download my link:src/main/resources/kaitai/pdb.ksy[`pdb.ksy`], click
on its link, then click on the `Raw` button in the header above the
first line of the listing, then tell your browser to save it to disk.
Be sure to keep the `.ksy` extension. Then you can upload it to the
Kaitai Struct Web IDE.


== ANLZ Data

Each track in a rekordbox database also has `ANLZnnnn.DAT` and
`ANLZnnn.EXT` files associated with it, containing the beat grid, an
index allowing rapid seeking to any time in variable-bitrate audio
files, the waveforms, memory cues and loop points. The paths to these
files are found inside the corresponding track record.

The structure definitions for these files are in
link:src/main/resources/kaitai/anlz.ksy[`anlz.ksy`]. You can use it
with the Kaitai Struct Web IDE as described
<<exploring-the-analysis,above>> to explore analysis
files found in your own exported media.

== Unfinished Tasks

* The process of actually fetching the databases from the players using
NFS is under active development now.

* A document explaining the structures with diagrams, along the lines
of the Dysentery Packet Analysis, will be part of this project as well.

* There are still more tables to be figured out. `Columns` looks like
the list of things that can be searched by, so perhaps it will hold
some clues for how to find and use the index tables, which must exist
because it would be horribly slow for the players to do a linear scan
through the main sparse tables whenever they wanted a record.

* If we could figure out how to use the indices ourselves, we could
avoid having to load the whole file and index it ourselves.

== Using the Library

There are a set of Java classes created from the mapping files, and
bundled into a library that is published to Maven Central. As soon as
I have finished testing them in the context of Beat Link, I will write
up some documentation here about how to use them, pointing at the
relevant parts of Beat Link as examples.

== Building the source

The Maven project uses a plugin to run the the `jrpcgen` tool
(which is part of the
https://sourceforge.net/projects/remotetea/[Remote Tea
project]) to generate Java classes to implement the
ONC RPC specifications found in `src/main/rpc`.
(These are used for communicating with the NFS servers
in CDJs.) It also uses the http://kaitai.io[Kaitai Struct Compiler]
through another plugin to generate Java classes that can parse the
rekordbox databases it downloads from the players, based on the
specifications found in `src/main/kaitai`.

== Licenses

+++<a href="http://deepsymmetry.org"><img src="assets/DS-logo-bw-200-padded-left.png" align="right" alt="Deep Symmetry logo" width="216" height="123"></a>+++
Copyright Â© 2018 http://deepsymmetry.org[Deep Symmetry, LLC]

Distributed under the
http://opensource.org/licenses/eclipse-1.0.php[Eclipse Public License
1.0], the same as Clojure. By using this software in any fashion, you
are agreeing to be bound by the terms of this license. You must not
remove this notice, or any other, from this software. A copy of the
license can be found in link:LICENSE[LICENSE] within this project.

Remote Tea is licensed under the
https://opensource.org/licenses/LGPL-2.0[GNU Library General
Public License, version 2].

The https://github.com/kaitai-io/kaitai_struct_compiler[Kaitai Struct
Compiler] is licensed under the
https://opensource.org/licenses/GPL-3.0[GNU General Public License,
version 3] and the Kaitai Java runtime embedded in crate-digger is
licensed under the https://opensource.org/licenses/MIT[MIT License].